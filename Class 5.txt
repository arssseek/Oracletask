CREATE TABLE empl(
FULL_NAME VARCHAR2(40) NOT NULL,
PHONE_NUMBER VARCHAR(13) NOT NULL,
BIRTHDAY DATE,
FLOOR VARCHAR2(25),
CONSTRAINT CHECK_PHONE_NUMBER
CHECK (PHONE_NUMBER LIKE ('+375_________')),
CONSTRAINT empl_pk PRIMARY KEY (FULL_NAME, PHONE_NUMBER)
)


CREATE OR REPLACE DIRECTORY BCP_DIR AS 'C:\Program Files\Oracle\Ñlass5_card';
CREATE TABLE card(
CARDNUM NUMBER(4) NOT NULL,
FULL_NAME VARCHAR2(40) NOT NULL,
PHONE_NUMBER VARCHAR(13) NOT NULL,
CARD_DATE DATE
)
ORGANIZATION EXTERNAL (
TYPE ORACLE_LOADER
DEFAULT DIRECTORY BCP_DIR
ACCESS PARAMETERS (
RECORDS DELIMITED BY NEWLINE
FIELDS TERMINATED BY ','
MISSING FIELD VALUES ARE NULL
(
CARDNUM CHAR(4),
FULL_NAME CHAR(50),
PHONE_NUMBER CHAR(13),
CARD_DATE CHAR(9)
)
)
LOCATION ('Class5_card.txt')
)
REJECT LIMIT UNLIMITED;



CREATE TABLE PAK(
CARDNUM NUMBER(4) NOT NULL,
ATIME TIMESTAMP,
READER  NUMBER(4),
ALARM NUMBER(1) DEFAULT 0 NOT NULL,
CONSTRAINT CHECK_ALARM
CHECK (ALARM = 0 OR ALARM = 1),
CONSTRAINT fk_card
FOREIGN KEY (CARDNUM) 
REFERENCES card(CARDNUM)
)
PARTITION BY RANGE (ATIME)
INTERVAL(NUMTODSINTERVAL(1, 'DAY'))
( 
PARTITION p0 VALUES LESS THAN (TO_DATE('07.12.1995,06:00','DD.MM.YYYY,HH24.MI')),
PARTITION p1 VALUES LESS THAN (TO_DATE('08.12.1995,06:00','DD.MM.YYYY,HH24.MI')),
PARTITION p2 VALUES LESS THAN (TO_DATE('09.12.1995,06:00','DD.MM.YYYY,HH24.MI'));





SELECT DISTINCT
    CASE 
        WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1  THEN cardnum
END as late , 
COUNT(*) OVER (
PARTITION BY (
    CASE  
    WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1 THEN cardnum 
END))
FROM PAK
WHERE ATIME IN (
    SELECT MIN(ATIME) OVER (PARTITION BY EXTRACT(DAY FROM ATIME), cardnum)
    FROM PAK
WHERE reader = 1 AND EXTRACT(HOUR FROM atime) > 6
) AND ( 
CASE 
    WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1 THEN cardnum
END IS NOT NULL)




SELECT DISTINCT
    CASE 
        WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1  THEN cardnum
END as late ,  SUM((EXTRACT(HOUR FROM ATIME) - 9)*60 + EXTRACT(MINUTE FROM ATIME))
OVER (
PARTITION BY (
    CASE  
    WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1 THEN cardnum 
END))
FROM PAK
WHERE ATIME IN (
    SELECT MIN(ATIME) OVER (PARTITION BY EXTRACT(DAY FROM ATIME), cardnum)
    FROM PAK
WHERE reader = 1 AND EXTRACT(HOUR FROM atime) > 6
) AND ( 
CASE 
    WHEN EXTRACT(HOUR FROM ATIME) > 8 AND reader = 1 THEN cardnum
END IS NOT NULL)




SELECT DISTINCT a.dy, a.cardnum, 
CASE
    WHEN b.mnt - a.mxt < 0 THEN TRUNC((b.mnt - a.mxt )/60 + 21)||' Hours and '||MOD((b.mnt - a.mxt + 1260),60)|| ' minutes'
    WHEN b.mnt - a.mxt = 0 THEN 'lazy person'
    ELSE TRUNC((b.mnt - a.mxt)/60)||' Hours and '||MOD((b.mnt - a.mxt),60)|| ' minutes'
END AS Timee
FROM((
    SELECT EXTRACT(DAY FROM ATIME) as dy, cardnum, reader, SUM(
        CASE
            WHEN EXTRACT(HOUR FROM ATIME) < 9 THEN 540
            WHEN EXTRACT(HOUR FROM ATIME) > 20 THEN 1260
            ELSE ((EXTRACT(HOUR FROM ATIME)*60)+ EXTRACT(MINUTE FROM ATIME))
        END)
        OVER(PARTITION BY EXTRACT(DAY FROM ATIME), cardnum, reader) as mxt
    FROM PAK
    WHERE alarm = 0 AND reader = 1) a
JOIN
    (SELECT EXTRACT(DAY FROM ATIME) as dy, cardnum, reader, SUM(
        CASE
            WHEN EXTRACT(HOUR FROM ATIME) < 9 THEN 0
            WHEN EXTRACT(HOUR FROM ATIME) > 20 THEN 1260
            ELSE ((EXTRACT(HOUR FROM ATIME)*60)+ EXTRACT(MINUTE FROM ATIME))
        END)
        OVER(PARTITION BY EXTRACT(DAY FROM ATIME), cardnum, reader) as mnt
    FROM PAK
    WHERE alarm = 0 AND reader = 2) b 
ON a.dy = b.dy AND a.cardnum = b.cardnum)



